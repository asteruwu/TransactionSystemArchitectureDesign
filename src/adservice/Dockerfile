# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# 1. åŸºç¡€é•œåƒä¿æŒ JDK 21
FROM eclipse-temurin:21.0.5_11-jdk AS builder

WORKDIR /app

# ğŸ”¥ã€å…³é”®ã€‘é…ç½® Gradle å…¨å±€ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
# æˆ‘ä»¬ç›´æ¥å†™å…¥ä¸€ä¸ª init.gradle åˆå§‹åŒ–è„šæœ¬ï¼ŒGradle å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½å®ƒ
RUN mkdir -p ~/.gradle && \
    echo "allprojects { repositories { maven { url 'https://maven.aliyun.com/repository/public/' } } }" > ~/.gradle/init.gradle

COPY ["build.gradle", "gradlew", "./"]
COPY gradle gradle

# èµ‹äºˆæ‰§è¡Œæƒé™
RUN chmod +x gradlew

# 2. ä¸‹è½½ä¾èµ– (è¿™æ—¶å€™å°±ä¼šé£å¿«åœ°èµ°é˜¿é‡Œäº‘äº†)
RUN ./gradlew downloadRepos

COPY . .
RUN chmod +x gradlew
RUN ./gradlew installDist

# 3. è¿è¡Œæ—¶é•œåƒï¼šå»ºè®®ç»Ÿä¸€ç”¨ JDK 21-alpine (åŸæ–‡ä»¶å†™çš„ 25 å¯èƒ½æ˜¯ç¬”è¯¯ï¼Œ21 æ˜¯ LTS ä¸”åŒ¹é… builder)
FROM eclipse-temurin:21-jre-alpine

# ğŸ”¥ã€å…³é”®ã€‘Alpine ç³»ç»Ÿæ¢æº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
RUN apk update && apk add --no-cache ca-certificates

WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰© (è¿™é‡Œä¿ç•™åŸé€»è¾‘ï¼ŒæŠŠæ•´ä¸ª app ç›®å½•æ‹·è¿‡æ¥ï¼Œè™½ç„¶ç•¥å¤§ä½†æœ€ç¨³)
COPY --from=builder /app .

EXPOSE 9555

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/build/install/hipstershop/bin/AdService"]
